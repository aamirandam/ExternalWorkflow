name: Release Workflow

on:
  workflow_run:
    workflows: ["Simple Workflow"]
    types:
      - completed

jobs:
  release:
    # if: github.event.workflow_run.event == 'completed' # && github.event.workflow_run.workflow != 'Release Workflow' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          python-version: '16'  

      - name: Install semver library
        run: npm install semver
       
      - name: Checkout code
        uses: actions/checkout@v2
        
      - name: Get latest tag
        id: get_tag
        run: |
          git fetch --tags
          latest_tag=$(git describe --tags $(git rev-list --tags --max-count=1))
          echo "LATEST_TAG=${latest_tag}" >> $GITHUB_ENV

      - name: Use latest tag
        run: echo "Latest tag is $LATEST_TAG"
        
      - name: Checkout code
        uses: actions/checkout@v2
        
      - name: Determine version increment type
        id: determine_increment_type
        run: |
          LAST_COMMIT=$(git log -1 --pretty=%B)
          if [[ $LAST_COMMIT == *"BREAKING CHANGE"* ]]; then
            echo "INCREMENT_TYPE=major" >> $GITHUB_ENV
          elif [[ $LAST_COMMIT == *"feat"* ]]; then
            echo "INCREMENT_TYPE=minor" >> $GITHUB_ENV
          else [[ $LAST_COMMIT == *"fix"* ]];
            echo "INCREMENT_TYPE=patch" >> $GITHUB_ENV
          fi
  
        # node -e 'const semver = require("semver"); const tag = process.env.TAG; const incrementType = process.env.INCREMENT_TYPE; console.log(semver.inc(tag, incrementType));'
      - name: Increment tag
        id: increment_tag
        run: |
          echo ${{ env.INCREMENT_TYPE }}
          increment_type=$(cat $GITHUB_ENV)
          if [[ "${increment_type}" != "none" ]]; then
            incremented_tag=$(node -e "const semver = require('semver'); const tag = '${LATEST_TAG}'; const incrementType = '${increment_type}'; console.log(semver.inc(tag, incrementType));")
            echo "INCREMENTED_TAG=${incremented_tag}" >> $GITHUB_ENV
          fi

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INCREMENTED_TAG: ${{ env.INCREMENTED_TAG }}
        with:
          tag_name: ${{ env.INCREMENTED_TAG }}
          release_name: Release ${{ env.INCREMENTED_TAG }}
          body: |
            Release notes go here
          draft: false
          prerelease: false
