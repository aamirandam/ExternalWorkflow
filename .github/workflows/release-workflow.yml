name: Release Workflow

on:
  workflow_run:
    workflows: ["Simple Workflow"]
    types:
      - completed

jobs:
  release-branch:
    # if: github.event.workflow_run.event == 'completed' # && github.event.workflow_run.workflow != 'Release Workflow' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'  # Use the latest Python 3.x version

      - name: Install semver library
        run: pip install semver
        
      - name: Checkout code
        uses: actions/checkout@v2
  
      - name: Get latest tag
        id: get_tag
        run: |
          git fetch --tags
          latest_tag=$(git describe --tags $(git rev-list --tags --max-count=1))
          echo "LATEST_TAG=${latest_tag}" >> $GITHUB_ENV

      - name: Use latest tag
        run: echo "Latest tag is $LATEST_TAG"
  
      - name: Determine version increment type
        id: determine_increment_type
        run: |
          LAST_COMMIT=$(git log -1 --pretty=%B)
          if [[ $LAST_COMMIT == *"BREAKING CHANGE"* ]]; then
            echo "major"
          elif [[ $LAST_COMMIT == *"feat:"* ]]; then
            echo "minor"
          elif [[ $LAST_COMMIT == *"fix:"* ]]; then
            echo "patch"
          else
            echo "none"
          fi
  
        # node -e 'const semver = require("semver"); const tag = process.env.TAG; const incrementType = process.env.INCREMENT_TYPE; console.log(semver.inc(tag, incrementType));'
      - name: Increment tag
        id: increment_tag
        run: |
          increment_type=$(cat $GITHUB_ENV)
          if [[ "${increment_type}" != "none" ]]; then
            incremented_tag=$(python -c "import semver; print(semver.bump_${{ steps.determine_increment_type.outputs.INCREMENT_TYPE }}('${{ steps.get_tag.outputs.LATEST_TAG }}'))")
            echo "INCREMENTED_TAG=${incremented_tag}" >> $GITHUB_ENV
          fi
  
      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.INCREMENTED_TAG }}
          release_name: Release ${{ env.INCREMENTED_TAG }}
          body: |
            Release notes go here
          draft: false
          prerelease: false
